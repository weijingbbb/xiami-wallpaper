"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/system.js"),l=require("../../api/apis.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"preview",setup(o){const i=e.ref(!0),t=e.ref(null),u=e.ref(null),s=e.ref(0),n=e.ref([]),r=e.ref(null),c=e.ref(0),p=e.ref({score:5}),v=e.ref(!1),d=e.ref([]),m=e.index.getStorageSync("storgClassList")||[];n.value=m.map(e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")})),e.onLoad(async e=>{if(r.value=e.id,"share"==e.type){let e=await l.apiDetailWall({id:r.value});n.value=e.data.map(e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")}))}c.value=n.value.findIndex(e=>e._id==r.value),p.value=n.value[c.value],j()});const f=e=>{c.value=e.detail.current,p.value=n.value[c.value],j()};console.log(n.value);const h=()=>{t.value.open()},g=()=>{t.value.close()},w=()=>{p.value.userScore&&(v.value=!0,s.value=p.value.userScore),u.value.open()},x=()=>{u.value.close(),s.value=0,v.value=!1},y=async()=>{e.index.showLoading({title:"加载中..."});let{classid:a,_id:o}=p.value,i=await l.apiGetSetupScore({classid:a,wallId:o,userScore:s.value});e.index.hideLoading(),0===i.errCode&&(e.index.showToast({title:"评分成功",icon:"none"}),n.value[c.value].userScore=s.value,e.index.setStorageSync("storgClassList",n.value),x())},_=()=>{i.value=!i.value},S=()=>{e.index.navigateBack({success:()=>{},fail:a=>{e.index.reLaunch({url:"/pages/index/index"})}})},b=async()=>{try{e.index.showLoading({title:"下载中...",mask:!0});let{classid:o,_id:i}=p.value,t=await l.apiWriteDownload({classid:o,wallId:i});if(0!=t.errCode)throw t;e.index.getImageInfo({src:p.value.picurl,success:a=>{e.index.saveImageToPhotosAlbum({filePath:a.path,success:a=>{e.index.showToast({title:"保存成功，请到相册查看",icon:"none"})},fail:a=>{"saveImageToPhotosAlbum:fail cancel"!=a.errMsg?e.index.showModal({title:"授权提示",content:"需要授权保存相册",success:a=>{a.confirm&&e.index.openSetting({success:a=>{console.log(a),a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取权限失败",icon:"none"})}})}}):e.index.showToast({title:"保存失败，请重新点击下载",icon:"none"})},complete:()=>{e.index.hideLoading()}})}})}catch(a){console.log(a),e.index.hideLoading()}};function j(){d.value.push(c.value<=0?n.value.length-1:c.value-1,c.value,c.value>=n.value.length-1?0:c.value+1),d.value=[...new Set(d.value)]}return e.onShareAppMessage(e=>({title:"虾米壁纸",path:"/pages/preview/preview?id="+r.value+"&type=share"})),e.onShareTimeline(()=>({title:"虾米壁纸",query:"id="+r.value+"&type=share"})),(l,o)=>e.e({a:p.value._id},p.value._id?e.e({b:e.f(n.value,(a,l,o)=>e.e({a:d.value.includes(l)},d.value.includes(l)?{b:e.o(_,a._id),c:a.picurl}:{},{d:a._id})),c:c.value,d:e.o(f),e:i.value},i.value?{f:e.p({type:"back",color:"#fff",size:"20"}),g:e.o(S),h:e.unref(a.getStatusBarHeight)()+"px",i:e.t(c.value+1),j:e.t(n.value.length),k:e.p({date:new Date,format:"hh:mm"}),l:e.p({date:new Date,format:"MM月dd日"}),m:e.p({type:"info",size:"28"}),n:e.o(h),o:e.p({type:"star",size:"28"}),p:e.t(p.value.score),q:e.o(w),r:e.p({type:"download",size:"23"}),s:e.o(b)}:{},{t:e.p({type:"closeempty",size:"18",color:"#999"}),v:e.o(g),w:e.t(p.value._id),x:e.t(p.value.nickname),y:e.p({readonly:!0,touchable:!0,value:p.value.score,size:"16"}),z:e.t(p.value.score),A:e.t(p.value.description),B:e.f(p.value.tabs,(a,l,o)=>({a:e.t(a),b:a})),C:e.sr(t,"a11ec731-6",{k:"infoPopup"}),D:e.p({type:"bottom","safe-area":!1}),E:e.t(v.value?"已经评分啦":"壁纸评分"),F:e.p({type:"closeempty",size:"18",color:"#999"}),G:e.o(x),H:e.o(e=>s.value=e),I:e.p({allowHalf:!0,disabled:v.value,"disabled-color":"#FFCA3E",modelValue:s.value}),J:e.t(s.value),K:e.o(y),L:!s.value||v.value,M:e.sr(u,"a11ec731-9",{k:"scorePopup"}),N:e.p({"is-mask-click":!1})}):{})}},i=e._export_sfc(o,[["__scopeId","data-v-a11ec731"]]);o.__runtimeHooks=6,wx.createPage(i);
